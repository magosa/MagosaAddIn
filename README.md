# MagosaAddIn - PowerPoint図形操作補助アドイン

PowerPointでの図形操作を効率化するVSTOアドインです。図形の整列・分割・配置・選択補助・ハンドル調整・レイヤー管理・ナンバリング・置き換え機能を提供します。

## 🚀 機能概要

### 📐 図形整列機能
- **基準整列**: 左端・右端・上端・下端・水平中央・垂直中央揃え
- **隣接整列**: 基準図形に隣接した配置
- **拡張整列**: 等間隔配置・マージン配置・グリッド配置・円形配置

### ✂️ 図形分割機能
- **単一図形分割**: 1つの四角形を指定グリッドに分割
- **複数図形グリッド分割**: 複数図形の範囲内でグリッド分割
- **スタイル保持**: 元図形の書式を新しい図形に継承

### 🎯 選択補助機能
- **同一書式選択**: 基準図形と同じ書式を持つ図形を自動選択
- **選択条件**: 塗りつぶし色・枠線スタイル・シェイプ種類から選択可能
- **リアルタイムプレビュー**: 条件変更時に一致する図形数を表示

### 🔧 図形ハンドル調整機能
- **調整ハンドル設定**: 角丸・矢印・星形などの図形パラメータを一括調整
- **角度ハンドル設定**: 円弧・扇形・ブロック円弧などの角度を度数単位で設定
- **単位変換対応**: mm単位、度数単位での直感的な値入力
- **調整リセット**: すべての調整ハンドルをデフォルト値に戻す

### 📚 レイヤー（重なり順）調整機能
- **選択順配置**: 選択した順番に前面・背面へ配置
- **位置基準配置**: 左から右、上から下の順に前面へ配置
- **重なり制御**: 複雑な図形の重なり順を簡単に整理

### 🔢 自動ナンバリング機能
- **多様なフォーマット**: 算用数字、丸数字、アルファベット、ローマ数字
- **柔軟な設定**: 開始番号・増分値・フォントサイズを指定可能
- **テキスト継承**: 既存テキストの先頭に番号を追加

### 🔄 図形置き換え機能
- **一括置き換え**: 複数図形をテンプレート図形で一括置換
- **サイズ選択**: 元のサイズ維持 or テンプレートサイズ統一
- **属性継承**: スタイル（塗り・線・影）とテキストの継承オプション
- **中心位置保持**: 置き換え後も図形の中心位置を維持

## 🛠️ 技術仕様

### 開発環境
- **開発ツール**: Visual Studio 2022
- **言語**: C#
- **フレームワーク**: .NET Framework 4.7.2
- **技術**: VSTO (Visual Studio Tools for Office)
- **配置方式**: ClickOnce
- **バージョン**: 1.0.6

### 対象アプリケーション
- Microsoft PowerPoint (Office 365 / 2019 / 2021)

### アーキテクチャ
```
MagosaAddIn/
├── Core/ # ビジネスロジック層
│   ├── ShapeAligner.cs           # 図形整列機能
│   ├── ShapeDivider.cs           # 図形分割機能
│   ├── ShapeSelector.cs          # 図形選択補助機能
│   ├── ShapeHandleAdjuster.cs    # 図形ハンドル調整機能 [NEW]
│   ├── ShapeLayerManager.cs      # レイヤー（重なり順）管理 [NEW]
│   ├── ShapeNumbering.cs         # 自動ナンバリング機能 [NEW]
│   ├── ShapeReplacer.cs          # 図形置き換え機能 [NEW]
│   ├── ShapeStyle.cs             # 図形スタイル管理
│   ├── Constants.cs              # 定数定義
│   ├── ComExceptionHandler.cs    # COM例外処理統一
│   ├── ErrorHandler.cs           # エラーハンドリング統一
│   └── DataModels.cs             # 共通データクラス
├── UI/ # ユーザーインターフェース層
│   ├── CustomRibbon.cs           # リボンUI制御
│   ├── CustomRibbon.Designer.cs  # リボンUIデザイン
│   ├── DialogClasses.cs          # 各種設定ダイアログ
│   └── RibbonHelper.cs           # リボン共通処理
└── Properties/ # アセンブリ情報
```

## 📋 機能詳細

### 🔧 図形整列機能

#### 基準整列
| 機能 | 説明 |
|------|------|
| 左端揃え | 基準図形の左端に他図形を揃える |
| 右端揃え | 基準図形の右端に他図形を揃える |
| 上端揃え | 基準図形の上端に他図形を揃える |
| 下端揃え | 基準図形の下端に他図形を揃える |
| 水平中央揃え | 基準図形の水平中央に他図形を揃える |
| 垂直中央揃え | 基準図形の垂直中央に他図形を揃える |

#### 隣接整列
| 機能 | 説明 |
|------|------|
| 左端→右端隣接 | 基準図形の左端に他図形の右端を隣接 |
| 右端→左端隣接 | 基準図形の右端に他図形の左端を隣接 |
| 上端→下端隣接 | 基準図形の上端に他図形の下端を隣接 |
| 下端→上端隣接 | 基準図形の下端に他図形の上端を隣接 |

#### 拡張整列
| 機能 | 説明 |
|------|------|
| 水平中央・等間隔 | 水平中央揃え＋等間隔配置 |
| 垂直中央・等間隔 | 垂直中央揃え＋等間隔配置 |
| 水平マージン配置 | 任意マージンで水平配置 |
| 垂直マージン配置 | 任意マージンで垂直配置 |
| グリッド配置 | 指定列数でグリッド状配置 |
| 円形配置 | 指定中心・半径で円形配置 |

### ✂️ 図形分割機能

#### 単一図形分割
- 1つの四角形を指定した行×列のグリッドに分割
- 元図形のスタイル（塗りつぶし・枠線・影）を保持
- 水平・垂直マージンを個別設定可能

#### 複数図形グリッド分割
- 複数図形の範囲内でグリッド分割を実行
- 元図形削除の選択可能
- 四角形以外の図形に対する警告表示

### 🎯 選択補助機能

#### 選択条件
| 条件 | 説明 |
|------|------|
| 塗りのカラーコード | RGB値が同じ図形を選択 |
| 枠線のスタイル | 色・太さ・破線パターンが同じ図形を選択 |
| 塗りと枠線のスタイル | 塗りつぶしと枠線の両方が同じ図形を選択 |
| シェイプの種類 | 四角形・円・三角形など同じ種類の図形を選択 |

#### 特徴
- **基準図形も含む選択**: 基準図形と条件に合致する全ての図形を選択
- **リアルタイムプレビュー**: 条件変更時に一致する図形数を即座に表示
- **詳細なシェイプ判定**: オートシェイプの具体的な形状まで識別

### 🔧 図形ハンドル調整機能

#### 調整ハンドル設定
| 機能 | 説明 |
|------|------|
| 正規化値設定 | PowerPoint内部形式（0.0～1.0）での設定 |
| mm単位設定 | 直感的なmm単位での設定（自動変換） |
| 一括設定 | 複数図形のハンドルを同時に調整 |
| 調整リセット | すべてのハンドルをデフォルト値に戻す |

#### 角度ハンドル設定
| 機能 | 説明 |
|------|------|
| 度数単位設定 | 0～360度での直感的な角度指定 |
| 左回り基準 | 反時計回り（左回り）での角度入力 |
| 図形タイプ別変換 | 円弧・扇形・ブロック円弧など図形別に最適化 |
| 内径比率設定 | ドーナツ・ブロック円弧の内径をパーセント指定 |

#### 対応図形タイプ
**調整ハンドル対応図形**:
- 四角形系: 角丸四角形、切り取り角、各種角処理
- 矢印系: 各種矢印、山形、矢じり調整
- 星形系: 4pt～32pt星、内側頂点位置調整
- 吹き出し: 四角形・円形・雲形の吹き出し線位置調整
- その他: 平行四辺形、台形、リボン、スクロールなど80種類以上

**角度ハンドル対応図形**:
- 円弧、弦、扇形（部分円）
- ブロック円弧（開始角度・終了角度・内径比率）
- ドーナツ（内径比率）
- 三日月（角度調整）

### 📚 レイヤー（重なり順）調整機能

#### 調整方法
| 機能 | 説明 |
|------|------|
| 選択順に前面へ配置 | 選択した順番に図形を前面へ配置 |
| 選択順に背面へ配置 | 選択した順番に図形を背面へ配置 |
| 左から右へ前面に配置 | 左側の図形を背面、右側を前面に配置 |
| 上から下へ前面に配置 | 上側の図形を背面、下側を前面に配置 |

### 🔢 自動ナンバリング機能

#### 番号フォーマット
| フォーマット | 例 | 説明 |
|------------|-----|------|
| 算用数字 | 1, 2, 3... | 標準的な数字表記 |
| 丸数字 | ①②③... | Unicode丸数字（①～㊿まで対応） |
| 大文字アルファベット | A, B, C... | 大文字での連番 |
| 小文字アルファベット | a, b, c... | 小文字での連番 |
| ローマ数字大文字 | I, II, III... | 大文字ローマ数字（1～3999） |
| ローマ数字小文字 | i, ii, iii... | 小文字ローマ数字（1～3999） |

#### 設定項目
- **開始番号**: 0～999の範囲で指定
- **増分値**: -10～+10の範囲で指定（マイナス値で逆順も可能）
- **フォントサイズ**: ポイント単位で指定
- **既存テキスト**: 既存テキストがある場合は先頭に番号を追加

### 🔄 図形置き換え機能

#### 置き換えプロセス
1. **選択完了**: 置き換え対象の図形を複数選択して記憶
2. **テンプレート選択**: 置き換えに使用する図形を1つ選択
3. **オプション設定**: サイズモード・スタイル継承・テキスト継承を選択
4. **置き換え実行**: 記憶した図形をテンプレート図形で一括置換

#### サイズモード
| モード | 説明 |
|--------|------|
| 元のサイズを維持 | 各図形の元のサイズを保持して置換 |
| テンプレートサイズに統一 | すべての図形をテンプレートサイズに統一 |

#### 継承オプション
| オプション | 説明 |
|-----------|------|
| スタイル継承 | 元図形の塗りつぶし・枠線・影を新図形に適用 |
| テキスト継承 | 元図形のテキストを新図形に適用 |

#### 特徴
- **中心位置保持**: 置き換え後も各図形の中心位置を維持
- **一括処理**: 複数図形を一度に効率的に置換
- **安全な削除**: COM例外を考慮した元図形の削除処理

## 🎨 ユーザーインターフェース

### リボンUI構成
**タブ名**: "Magosa Tools"

| グループ | 機能 |
|----------|------|
| 図形操作 | グリッド分割 |
| 基準整列 | 左端・右端・上端・下端・水平中央・垂直中央揃え |
| 隣接整列 | 各方向の隣接配置 |
| 拡張整列 | 等間隔・マージン・グリッド・円形配置 |
| 選択補助 | 同一書式選択 |
| ハンドル調整 | 調整ハンドル・角度ハンドル・調整リセット [NEW] |
| レイヤー調整 | 重なり順の調整 [NEW] |
| 自動ナンバリング | 図形への番号付け [NEW] |
| 図形置き換え | 選択完了・置き換え実行 [NEW] |

### ダイアログ
- **DivisionDialog**: 単一図形分割設定
- **GridDivisionDialog**: 複数図形グリッド分割設定
- **MarginDialog**: マージン値設定
- **GridArrangementDialog**: グリッド配置設定
- **CircleArrangementDialog**: 円形配置設定
- **ShapeSelectionDialog**: 図形選択条件設定
- **DynamicHandleDialog**: 調整ハンドル設定（動的UI生成） [NEW]
- **DynamicAngleHandleDialog**: 角度ハンドル設定（動的UI生成） [NEW]
- **LayerAdjustmentDialog**: レイヤー調整方法選択 [NEW]
- **NumberingDialog**: 自動ナンバリング設定 [NEW]
- **ShapeReplacementDialog**: 図形置き換えオプション設定 [NEW]

## 🔧 技術的特徴

### COM Interop対応
- **事前情報取得方式**: COM参照問題を回避
- **安全な削除処理**: COM例外を考慮した図形削除
- **有効性チェック**: スライド・図形参照の検証

### エラーハンドリング
- **統一されたCOM例外処理**: 全クラスで一貫した例外処理
- **詳細なログ出力**: デバッグとトラブルシューティング対応
- **ユーザーフレンドリーなメッセージ**: 分かりやすいエラー表示

### 設計パターン
- **責任分離**: UI層・ビジネスロジック層・データ層の分離
- **統一されたインターフェース**: 一貫したメソッド設計
- **拡張性**: 新機能追加が容易な設計

### パフォーマンス最適化
- **高速分析**: 図形ハンドル情報の高速取得（キャッシュ機構）
- **一括処理**: 複数図形の効率的な一括操作
- **メモリ管理**: 適切なCOMオブジェクトの解放

## 📊 制限事項

| 項目 | 制限値 |
|------|--------|
| 座標範囲 | -10,000pt ～ 10,000pt |
| 最小セルサイズ | 5pt |
| 最大分割数 | 50×50 |
| 対象図形（分割） | 四角形のみ |
| 選択補助（最小図形数） | 1個以上 |
| 整列（最小図形数） | 2個以上 |
| ハンドル調整（最小図形数） | 1個以上 |
| レイヤー調整（最小図形数） | 2個以上 |
| ナンバリング（最小図形数） | 1個以上 |
| 図形置き換え（最小図形数） | 1個以上 |
| 最大調整ハンドル数 | 8個 |
| ナンバリング開始番号 | 0～999 |
| ナンバリング増分値 | -10～+10 |

## 🚀 使用方法

### 基本操作
1. PowerPointで図形を選択
2. "Magosa Tools"タブから機能を選択
3. 必要に応じてダイアログで設定を入力
4. 実行

### 図形選択要件
- **整列機能**: 2つ以上の図形が必要
- **分割機能**: 1つ以上の四角形が必要
- **選択補助**: 1つの図形を基準として選択
- **ハンドル調整**: 1つ以上の対応図形が必要
- **レイヤー調整**: 2つ以上の図形が必要
- **ナンバリング**: 1つ以上の図形が必要
- **図形置き換え**: 記憶は1つ以上、テンプレートは1つ

### 図形ハンドル調整の使い方
1. 調整可能な図形（角丸四角形、矢印、星形、円弧など）を選択
2. 「調整ハンドル」または「角度ハンドル」ボタンをクリック
3. 動的に生成されたUIでハンドル値を入力
4. プレビューで確認しながら「適用」をクリック

### 図形置き換えの使い方
1. 置き換えたい図形を複数選択し「選択完了」をクリック
2. テンプレートにする図形を1つ選択
3. 「置き換え実行」をクリックしてオプションを設定
4. 実行すると記憶した図形がテンプレート図形で置き換わる

## 📄 ライセンス
このプロジェクトは個人・商用利用可能です。詳細はライセンスファイルを参照してください。

## 🐛 バグレポート・機能要望
バグレポートや機能要望は、GitHubのIssuesページでお知らせください。

## 📝 更新履歴
### Version 1.0.6 (最新)
- 図形ハンドル調整機能を追加（調整ハンドル・角度ハンドル）
- レイヤー（重なり順）調整機能を追加
- 自動ナンバリング機能を追加（6種類のフォーマット対応）
- 図形置き換え機能を追加（一括置換・属性継承）
- 水平中央揃え・垂直中央揃え機能を追加
- エラーハンドリングとログ機構を強化
- パフォーマンス最適化（図形分析の高速化）

---
**MagosaAddIn** - PowerPointでの図形操作をより効率的に！
